#
# RPM build specification file for Yandex ClickHouse DBMS
#
# Copyright (C) 2016 Red Soft LLC
# Copyright (C) 2017 Altinity Ltd
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# All RPMs 'magic' is described here:
# https://fedoraproject.org/wiki/How_to_create_an_RPM_package

# rpm --showrc will show you all of the macros

# Macros available:
# @CH_VERSION@="1.1.54289"
# @CH_TAG@="stable"

# CentOS 7 makes dist as ".el7.centos", we'd like to have dist=".el7", in order to use packages for RHEL as well, without renaming
%if 0%{?rhel} != 0
%define dist .el%{rhel}
%endif


Summary: Yandex ClickHouse DBMS
Name: clickhouse
Version: @CH_VERSION@
Release: 3%{?dist}
License: Apache License 2.0
Group: Applications/Databases
Source: ClickHouse-@CH_VERSION@-@CH_TAG@.zip
Url: https://clickhouse.yandex/
BuildRoot: %{_tmppath}/%{name}-%{version}-build

%description
ClickHouse is an open-source column-oriented database management
system that allows generating analytical data reports in real time.

%package server-common
Summary: Common configuration files for %{name}

%description server-common
This package contains common configuration files for ClickHouse DBMS.

%package server
Summary: %{name} server binary
Requires: %{name}-server-common = %{version}-%{release}

%description server
This package contains server binaries for ClickHouse DBMS.

%package client
Summary: %{name} client binary
Requires: %{name}-server = %{version}-%{release}

%description client
This package contains client binary for ClickHouse DBMS.

%package compressor
Summary: %{name} compressor binary

%description compressor
This package contains compressor utility for ClickHouse DBMS.

%prep
# see available macros spec
# @CH_VERSION@="1.1.54289"
# @CH_TAG@="stable"
%setup -q -n ClickHouse-%{version}-@CH_TAG@
CH_VERSION=@CH_VERSION@
CH_VERSION_ARR=(${CH_VERSION//./ })
# prepare cmake files
# VERSION_REVISION=54289
sed -i -- "s/VERSION_REVISION .*)/VERSION_REVISION ${CH_VERSION_ARR[2]})/g"   dbms/cmake/version.cmake
# VERSION_DESCRIBE=v1.1.54289-stable
sed -i -- "s/VERSION_DESCRIBE .*)/VERSION_DESCRIBE v@CH_VERSION@-@CH_TAG@)/g" dbms/cmake/version.cmake

%build
rm -rf build
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE:STRING=Release
make %{?_smp_mflags}
cd ..

%install
rm -rf %{buildroot}

DAEMONS="clickhouse clickhouse-compressor clickhouse-client clickhouse-server"

cd build
for daemon in $DAEMONS; do \
        DESTDIR=%{buildroot} cmake -DCOMPONENT=$daemon -P cmake_install.cmake; \
done
cd ..

mkdir -p %{buildroot}/etc/clickhouse-server
mkdir -p %{buildroot}/etc/clickhouse-client
mkdir -p %{buildroot}/etc/init.d
mkdir -p %{buildroot}/etc/cron.d
mkdir -p %{buildroot}/etc/security/limits.d/

mkdir -p %{buildroot}/usr/bin
mkdir -p %{buildroot}/usr/share/clickhouse/bin
mkdir -p %{buildroot}/usr/share/clickhouse/headers

cp -r %{_builddir}/%{buildsubdir}/debian/clickhouse-server.init   %{buildroot}/etc/init.d/clickhouse-server
cp -r %{_builddir}/%{buildsubdir}/debian/clickhouse-server.cron.d %{buildroot}/etc/cron.d/clickhouse-server
cp -r %{_builddir}/%{buildsubdir}/debian/clickhouse.limits        %{buildroot}/etc/security/limits.d/clickhouse.conf
cp -r %{_builddir}/%{buildsubdir}/dbms/src/Server/config.xml      %{buildroot}/etc/clickhouse-server/
cp -r %{_builddir}/%{buildsubdir}/dbms/src/Server/users.xml       %{buildroot}/etc/clickhouse-server/
#cp -r %{_builddir}/%{buildsubdir}/dbms/src/Client/config.xml %{buildroot}/etc/clickhouse-client/
cp -r %{buildroot}/usr/local/bin/* %{buildroot}/usr/bin
rm -rf %{buildroot}/usr/local


%clean
rm -rf %{buildroot}

%post compressor
CLICKHOUSE_USER=clickhouse
CLICKHOUSE_GROUP=${CLICKHOUSE_USER}
CLICKHOUSE_DATADIR=/var/lib/clickhouse

# Make sure the administrative user exists
if ! getent passwd ${CLICKHOUSE_USER} > /dev/null; then
	adduser \
		--system \
		--no-create-home \
		--home ${CLICKHOUSE_DATADIR} \
		--shell /sbin/nologin \
		--comment "Clickhouse server" \
		clickhouse > /dev/null
fi

# if the user was created manually, make sure the group is there as well
if ! getent group ${CLICKHOUSE_GROUP} > /dev/null; then
	addgroup --system ${CLICKHOUSE_GROUP} > /dev/null
fi

mkdir -p /etc/compressor/conf.d
chown -R ${CLICKHOUSE_USER}:${CLICKHOUSE_GROUP} /etc/compressor

%post server
if [ $1 = 1 ]; then
	/sbin/chkconfig --add clickhouse-server
fi

# CODE TAKEN FROM clickhouse-server-base.postinst (with update-rc logic commented out)

CLICKHOUSE_USER=clickhouse
CLICKHOUSE_GROUP=${CLICKHOUSE_USER}
CLICKHOUSE_DATADIR=/var/lib/clickhouse
CLICKHOUSE_LOGDIR=/var/log/clickhouse-server

#if [ -x "/etc/init.d/clickhouse-server" ]; then
#       update-rc.d clickhouse-server defaults 19 19 >/dev/null || exit $?
#fi

# Make sure the administrative user exists
if ! getent passwd ${CLICKHOUSE_USER} > /dev/null; then
	adduser \
		--system \
		--no-create-home \
		--home ${CLICKHOUSE_DATADIR} \
		--shell /sbin/nologin \
		--comment "Clickhouse server" \
		clickhouse > /dev/null
fi

# if the user was created manually, make sure the group is there as well
if ! getent group ${CLICKHOUSE_GROUP} > /dev/null; then
        addgroup --system ${CLICKHOUSE_GROUP} > /dev/null
fi

# make sure user is in the correct group
if ! id -Gn ${CLICKHOUSE_USER} | grep -qw ${CLICKHOUSE_USER}; then
        adduser ${CLICKHOUSE_USER} ${CLICKHOUSE_GROUP} > /dev/null
fi

# check validity of user and group
if [ "`id -u ${CLICKHOUSE_USER}`" -eq 0 ]; then
        echo "The ${CLICKHOUSE_USER} system user must not have uid 0 (root).
Please fix this and reinstall this package." >&2
        exit 1
fi

if [ "`id -g ${CLICKHOUSE_GROUP}`" -eq 0 ]; then
        echo "The ${CLICKHOUSE_USER} system user must not have root as primary group.
Please fix this and reinstall this package." >&2
        exit 1
fi

if [ ! -d ${CLICKHOUSE_DATADIR} ]; then
	mkdir -p ${CLICKHOUSE_DATADIR}
	chown ${CLICKHOUSE_USER}:${CLICKHOUSE_GROUP} ${CLICKHOUSE_DATADIR}
	chmod 700 ${CLICKHOUSE_DATADIR}
fi

if [ ! -d ${CLICKHOUSE_LOGDIR} ]; then
	mkdir -p ${CLICKHOUSE_LOGDIR}
	chown root:${CLICKHOUSE_GROUP} ${CLICKHOUSE_LOGDIR}
	# Allow everyone to read logs, root and clickhouse to read-write
	chmod 775 ${CLICKHOUSE_LOGDIR}
fi

# Clean old dynamic compilation results
if [ -d "${CLICKHOUSE_DATADIR}/build" ]; then
	rm -f ${CLICKHOUSE_DATADIR}/build/*.cpp ${CLICKHOUSE_DATADIR}/build/*.so ||:
fi

%preun server
if [ $1 = 0 ]; then
	/sbin/service clickhouse-server stop > /dev/null 2>&1
	/sbin/chkconfig --del clickhouse-server
fi

%postun server
if [ $1 -ge 1 ]; then
	/sbin/service clickhouse-server restart >/dev/null 2>&1
fi

%files server-common
/etc/clickhouse-server/config.xml
/etc/clickhouse-server/users.xml

%files server
/etc/cron.d/clickhouse-server
/etc/init.d/clickhouse-server
/etc/security/limits.d/clickhouse.conf
/usr/bin/clickhouse
/usr/bin/clickhouse-server
/usr/share/clickhouse

%files client
#/etc/clickhouse-client/config.xml
/usr/bin/clickhouse-client

%files compressor
/usr/bin/clickhouse-compressor

%changelog
* Wed May 17 2017 Vadim Tkachenko
- Adjust to build 54231 release
* Fri Mar 31 2017 Nikolay Samofatov <nikolay.samofatov@red-soft.biz>
- fix issue #5 - error with creating clickhouse user
* Wed Mar 01 2017 Nikolay Samofatov <nikolay.samofatov@red-soft.biz>
- update for 1.1.54165
* Fri Feb 10 2017 Nikolay Samofatov <nikolay.samofatov@red-soft.biz>
- update for 1.1.54159
* Fri Jan 13 2017 Nikolay Samofatov <nikolay.samofatov@red-soft.biz>
- update for 1.1.54127
* Mon Nov 14 2016 Nikolay Samofatov <nikolay.samofatov@red-soft.biz> 
- create spec file

